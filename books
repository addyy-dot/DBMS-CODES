-- Drop the database if it already exists and create a new one
DROP DATABASE IF EXISTS LibraryDB;
CREATE DATABASE LibraryDB;
USE LibraryDB;

-- Drop existing tables to avoid conflicts
DROP TABLE IF EXISTS Staff;
DROP TABLE IF EXISTS Book;
DROP TABLE IF EXISTS Student;

-- Create the Student table with constraints
CREATE TABLE Student (
    RollNo INT PRIMARY KEY,                               -- Primary key
    StudentName VARCHAR(100) NOT NULL,                    -- Cannot be null
    Department VARCHAR(50) NOT NULL,                      -- Cannot be null
    Year INT CHECK (Year BETWEEN 1 AND 4),                -- Year must be between 1 and 4
    UNIQUE (StudentName)                                  -- Student names must be unique
);

-- Create the Book table with constraints and foreign key
CREATE TABLE Book (
    BookID INT PRIMARY KEY,                               -- Primary key
    Title VARCHAR(100) NOT NULL,                          -- Cannot be null
    Department VARCHAR(50) NOT NULL,                      -- Cannot be null
    Type VARCHAR(20) CHECK (Type IN ('Journal', 'Textbook', 'Magazine')), -- Limited values
    IssuedTo INT,                                         -- References Student
    IssueYear YEAR,                                       -- Year when book was issued
    FOREIGN KEY (IssuedTo) REFERENCES Student(RollNo)     -- Foreign key to Student
);

-- Create the Staff table with foreign key to Book
CREATE TABLE Staff (
    StaffID INT PRIMARY KEY,                              -- Primary key
    StaffName VARCHAR(100) NOT NULL,                      -- Cannot be null
    BookIssued INT,                                       -- References Book
    FOREIGN KEY (BookIssued) REFERENCES Book(BookID)      -- Foreign key to Book
);

-- Alter table examples
ALTER TABLE Student ADD COLUMN PhoneNumber VARCHAR(15);   -- Add a new column
ALTER TABLE Student MODIFY COLUMN PhoneNumber VARCHAR(20);-- Modify column size
ALTER TABLE Student DROP COLUMN PhoneNumber;              -- Drop column

-- Insert sample student data
INSERT INTO Student (RollNo, StudentName, Department, Year) VALUES
(4225, 'Alice', 'COMP', 2),
(4226, 'Bob', 'MECH', 3),
(4227, 'Charlie', 'COMP', 1),
(4228, 'David', 'CIVIL', 4);

-- Insert sample book data
INSERT INTO Book (BookID, Title, Department, Type, IssuedTo, IssueYear) VALUES
(101, 'DBMS Concepts', 'COMP', 'Textbook', 4225, 2023),
(102, 'Thermodynamics', 'MECH', 'Textbook', 4226, 2022),
(103, 'Machine Design', 'MECH', 'Journal', NULL, NULL),
(104, 'Computer Networks', 'COMP', 'Journal', NULL, NULL),
(105, 'Engineering Mechanics', 'CIVIL', 'Textbook', 4228, 2023);

-- Insert sample staff data
INSERT INTO Staff (StaffID, StaffName, BookIssued) VALUES
(1, 'Mr. Sharma', 101),
(2, 'Ms. Gupta', 102),
(3, 'Mrs. Rao', 105);

-- i. Display total number of books in COMP department
SELECT Department, COUNT(*) AS TotalBooks
FROM Book
WHERE Department = 'COMP'
GROUP BY Department;

-- ii. Display total number of books issued by Roll No 4225
SELECT IssuedTo, COUNT(*) AS TotalIssued
FROM Book
WHERE IssuedTo = 4225
GROUP BY IssuedTo;

-- iii. Display details of all journals
SELECT * FROM Book
WHERE Type = 'Journal';

-- iv. Get details of all users who have not issued any book in year 2023
SELECT *
FROM Student
WHERE RollNo NOT IN (
    SELECT IssuedTo FROM Book WHERE IssueYear = 2023 AND IssuedTo IS NOT NULL
);

-- v. Get details of books from Computer Department
SELECT * FROM Book
WHERE Department = 'COMP';
